### [metrics-server](https://github.com/kubernetes-incubator/metrics-server) 是k8s自动扩缩容的度量指标组件，从kebulet处获取数值指标。
---
### 部署步骤
- 下载metrics-server的yaml文件  
``` 
cd /tmp
git clone https://github.com/kubernetes-incubator/metrics-server.git
```

- 修改metrics-server-deployment.yaml上的**imagePullPolicy**和**metrics**启动参数
```
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: metrics-server
  namespace: kube-system
  labels:
    k8s-app: metrics-server
spec:
  selector:
    matchLabels:
      k8s-app: metrics-server
  template:
    metadata:
      name: metrics-server
      labels:
        k8s-app: metrics-server
    spec:
      serviceAccountName: metrics-server
      volumes:
      # mount in tmp so we can safely use from-scratch images and/or read-only containers
      - name: tmp-dir
        emptyDir: {}
      containers:
      - name: metrics-server
        image: k8s.gcr.io/metrics-server-amd64:v0.3.3
        #把Always改成IfNotPresent
        imagePullPolicy: IfNotPresent
        command:
        - /metrics-server
        # metrics默认使用node name去连接kubelet的10250端口，为了防止解析失败，其他方式。按顺序进行连接
        - --kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP
        #此参数值要与kube-apiserver当中的值一致，表示使用此https证书
        - --requestheader-allowed-names=front-proxy-client
        #不能kubelet证书进行验证
        - --kubelet-insecure-tls
        volumeMounts:
        - name: tmp-dir
          mountPath: /tmp
```
- metrics默认60s拉取一次指标数据，可以使用```--metric-resolution=<duration>```进行修改。使用如下命令进行验证
```
[root@ecs-a4b7-0004 1.8+]# kubectl top node
NAME                      CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   
ecs-6575-0005.novalocal   91m          1%     912Mi           5%        
ecs-6575-0013.novalocal   93m          1%     1012Mi          6%        
ecs-a4b7-0004.novalocal   297m         3%     5035Mi          15%       
ecs-a4b7-0005.novalocal   111m         1%     961Mi           3%   
```
### 部署过程遇到的问题：
- 没加```--requestheader-allowed-names```导致访问kubelet失败，报x509的错误 
- 没加```--kubelet-insecure-tls```同样报x509错误
- 可能还会有容器之间的网络问题导致访问不了
